#!/usr/bin/env bash
set -eo pipefail

# reconup - Recon Fuzzer installer and updater
# Usage: reconup [github_token]
#
# Environment variables:
#   RECON_GITHUB_TOKEN - GitHub personal access token (required for private repo)
#   RECON_DIR         - Installation directory (default: ~/.recon)

RECON_DIR="${RECON_DIR:-$HOME/.recon}"
RECON_BIN_DIR="$RECON_DIR/bin"
RECON_BINARY="$RECON_BIN_DIR/recon"
REPO="Recon-Fuzz/recon-fuzzer"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}info${NC}: $1" >&2
}

log_success() {
    echo -e "${GREEN}success${NC}: $1" >&2
}

log_warn() {
    echo -e "${YELLOW}warn${NC}: $1" >&2
}

log_error() {
    echo -e "${RED}error${NC}: $1" >&2
}

# Get GitHub token from argument or environment
get_github_token() {
    if [[ -n "$1" ]]; then
        echo "$1"
    elif [[ -n "$RECON_GITHUB_TOKEN" ]]; then
        echo "$RECON_GITHUB_TOKEN"
    else
        echo ""
    fi
}

# Detect OS and architecture
detect_platform() {
    local os arch

    # Detect OS
    case "$(uname -s)" in
        Linux*)
            os="linux"
            ;;
        Darwin*)
            os="macos"
            ;;
        MINGW*|MSYS*|CYGWIN*|Windows_NT)
            os="windows"
            ;;
        *)
            log_error "Unsupported operating system: $(uname -s)"
            exit 1
            ;;
    esac

    # Detect architecture
    case "$(uname -m)" in
        x86_64|amd64)
            arch="x86_64"
            ;;
        arm64|aarch64)
            arch="aarch64"
            ;;
        *)
            log_error "Unsupported architecture: $(uname -m)"
            exit 1
            ;;
    esac

    echo "${os}-${arch}"
}

# Check if platform is supported
check_platform_support() {
    local platform="$1"

    case "$platform" in
        linux-x86_64|macos-aarch64)
            return 0
            ;;
        macos-x86_64|windows-x86_64)
            log_error "Sorry, we don't support your system ($platform) yet."
            log_info "Currently supported platforms:"
            log_info "  - linux-x86_64"
            log_info "  - macos-aarch64 (Apple Silicon)"
            log_info ""
            log_info "Support for $platform is planned for a future release."
            exit 1
            ;;
        *)
            log_error "Sorry, we don't support your system ($platform) yet."
            log_info "Currently supported platforms:"
            log_info "  - linux-x86_64"
            log_info "  - macos-aarch64 (Apple Silicon)"
            exit 1
            ;;
    esac
}

# Get current installed version
get_current_version() {
    if [[ -x "$RECON_BINARY" ]]; then
        # Try to get version from binary
        local version
        version=$("$RECON_BINARY" --version 2>/dev/null | head -n1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "")
        if [[ -n "$version" ]]; then
            echo "$version"
            return
        fi
    fi
    echo ""
}

# Get latest release version from GitHub
get_latest_version() {
    local token="$1"
    local api_url="https://api.github.com/repos/$REPO/releases/latest"
    local response

    if [[ -n "$token" ]]; then
        response=$(curl -sSf -H "Authorization: token $token" "$api_url" 2>/dev/null) || {
            log_error "Failed to fetch latest release info. Check your GitHub token."
            exit 1
        }
    else
        response=$(curl -sSf "$api_url" 2>/dev/null) || {
            log_error "Failed to fetch latest release info. A GitHub token may be required for private repos."
            log_info "Set RECON_GITHUB_TOKEN or pass token as argument: reconup <token>"
            exit 1
        }
    fi

    # Extract tag name and remove 'v' prefix
    local version
    version=$(echo "$response" | grep -oE '"tag_name":\s*"v?[0-9]+\.[0-9]+\.[0-9]+"' | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

    if [[ -z "$version" ]]; then
        log_error "Failed to parse latest version from GitHub API response"
        exit 1
    fi

    echo "$version"
}

# Compare versions (returns 0 if $1 > $2)
version_gt() {
    test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
}

# Download and install recon
install_recon() {
    local token="$1"
    local version="$2"
    local platform="$3"

    local filename="recon-${platform}.tar.gz"
    local download_url="https://github.com/$REPO/releases/download/v${version}/${filename}"

    log_info "Downloading recon v${version} for ${platform}..."

    # Create temp directory
    local tmp_dir
    tmp_dir=$(mktemp -d)
    trap "rm -rf $tmp_dir" EXIT

    local archive_path="$tmp_dir/$filename"

    # Download with authentication if token provided
    if [[ -n "$token" ]]; then
        # For private repos, we need to get the asset download URL
        local asset_url
        asset_url=$(get_asset_url "$token" "$version" "$filename")

        if [[ -z "$asset_url" ]]; then
            log_error "Failed to find download URL for $filename"
            exit 1
        fi

        curl -sSfL \
            -H "Authorization: token $token" \
            -H "Accept: application/octet-stream" \
            "$asset_url" \
            -o "$archive_path" || {
            log_error "Failed to download recon"
            exit 1
        }
    else
        curl -sSfL "$download_url" -o "$archive_path" || {
            log_error "Failed to download recon. A GitHub token may be required."
            exit 1
        }
    fi

    # Extract archive
    log_info "Extracting..."
    mkdir -p "$RECON_BIN_DIR"
    tar -xzf "$archive_path" -C "$tmp_dir"

    # Find the recon binary in extracted contents
    local recon_bin
    recon_bin=$(find "$tmp_dir" -name "recon" -type f ! -name "*.tar.gz" | head -1)

    if [[ -z "$recon_bin" ]]; then
        log_error "Could not find recon binary in archive"
        exit 1
    fi

    # Install binary
    mv "$recon_bin" "$RECON_BINARY"
    chmod +x "$RECON_BINARY"

    log_success "Installed recon v${version} to $RECON_BINARY"
}

# Get asset download URL from GitHub API (for private repos)
get_asset_url() {
    local token="$1"
    local version="$2"
    local filename="$3"

    local api_url="https://api.github.com/repos/$REPO/releases/tags/v${version}"
    local response

    response=$(curl -sSf -H "Authorization: token $token" "$api_url" 2>/dev/null) || {
        log_error "Failed to fetch release info for v${version}"
        return 1
    }

    # Parse JSON to find the asset URL for our filename
    # The "url" field comes before "name" in the asset object
    local asset_url
    asset_url=$(echo "$response" | grep -B5 "\"name\": \"$filename\"" | grep '"url"' | head -1 | grep -oE 'https://api.github.com/repos/[^"]+')

    echo "$asset_url"
}

main() {
    echo ""
    echo "  ____                      "
    echo " |  _ \ ___  ___ ___  _ __  "
    echo " | |_) / _ \/ __/ _ \| '_ \ "
    echo " |  _ <  __/ (_| (_) | | | |"
    echo " |_| \_\___|\___\___/|_| |_|"
    echo ""
    echo "  Recon Fuzzer Installer"
    echo ""

    # Get GitHub token
    local token
    token=$(get_github_token "$1")

    if [[ -z "$token" ]]; then
        log_warn "No GitHub token provided. This may fail for private repos."
        log_info "Set RECON_GITHUB_TOKEN or run: reconup <token>"
        echo ""
    fi

    # Detect and check platform
    local platform
    platform=$(detect_platform)
    log_info "Detected platform: $platform"
    check_platform_support "$platform"

    # Get versions
    local current_version latest_version
    current_version=$(get_current_version)
    latest_version=$(get_latest_version "$token")

    if [[ -n "$current_version" ]]; then
        log_info "Current version: v${current_version}"
    else
        log_info "Recon is not currently installed"
    fi
    log_info "Latest version: v${latest_version}"

    # Check if update is needed
    if [[ -n "$current_version" ]] && [[ "$current_version" == "$latest_version" ]]; then
        log_success "You already have the latest version (v${current_version})"
        echo ""
        return 0
    fi

    if [[ -n "$current_version" ]]; then
        if version_gt "$latest_version" "$current_version"; then
            log_info "Updating from v${current_version} to v${latest_version}..."
        else
            log_info "Current version is newer than latest release. Reinstalling v${latest_version}..."
        fi
    else
        log_info "Installing v${latest_version}..."
    fi

    echo ""

    # Install
    install_recon "$token" "$latest_version" "$platform"

    echo ""
    log_success "Done!"
    echo ""

    # Check PATH
    case ":$PATH:" in
        *":$RECON_BIN_DIR:"*)
            echo "Run 'recon --help' to get started."
            ;;
        *)
            echo "Add $RECON_BIN_DIR to your PATH to use recon:"
            echo ""
            echo "    export PATH=\"\$PATH:$RECON_BIN_DIR\""
            echo ""
            echo "Or add it to your shell profile for persistence."
            ;;
    esac
    echo ""
}

main "$@"
